---
- hosts: all
  sudo: yes
  tasks:
    - name: Add a new user
      user: name=t-hara
    - name: Install libselinux-python
      yum: name=libselinux-python state=latest

#================================================
# Install td-agent2
#================================================
- hosts:
    - fluentd
    - es
    - nk
  sudo: yes
  tasks:
    - name: Download td-agent2 installer
      get_url: url=https://td-toolbelt.herokuapp.com/sh/install-redhat-td-agent2.sh dest=/tmp/install-redhat-td-agent2.sh
    - name: Change mode of td-agent2 installer
      file: path=/tmp/install-redhat-td-agent2.sh mode="u=rwx,g=rw,o=rw"
    - name: Execute td-agent2 installer
      shell: /tmp/install-redhat-td-agent2.sh

#================================================
# Copy fluentd config files
#================================================
- hosts: fluentd
  sudo: yes
  tasks:
    - name: Copy config file
      copy: src=./files/fluentd-aggregator.conf dest=/etc/td-agent/td-agent.conf

- hosts: es
  sudo: yes
  tasks:
    - name: Copy config file
      copy: src=./files/fluentd-es.conf dest=/etc/td-agent/td-agent.conf

- hosts: nk
  sudo: yes
  tasks:
    - name: Copy config file
      copy: src=./files/fluentd-nk.conf dest=/etc/td-agent/td-agent.conf

#================================================
# Install Elasticsearch
# ref: http://qiita.com/dayflower/items/21c64a6f5da155a5ade3
#================================================
- hosts: es
  sudo: yes
  tasks:
    - name: Install Java
      yum: name=java-1.8.0 state=latest
    - name: Download rpm file and install Elasticsearch
      yum: name=https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.5.2.noarch.rpm state=present
    - name: Download kibana
      get_url: url=https://download.elastic.co/kibana/kibana/kibana-4.0.2-linux-x64.tar.gz dest=/tmp/kibana-4.0.2-linux-x64.tar.gz
    - name: Unarchive kibana.tar.gz
      command: tar zxf /tmp/kibana-4.0.2-linux-x64.tar.gz
    - name: Move kibana
      command: mv /home/vagrant/kibana-4.0.2-linux-x64 /usr/local/bin/

#================================================
# Install Git
#================================================
- hosts:
    - nk
    - git
  sudo: yes
  tasks:
    - name: Install git dependencies packages
      yum: name={{item}} state=latest
      with_items:
        - gcc
        - curl-devel
        - expat-devel
        - gettext-devel
        - openssl-devel
        - zlib-devel
        - perl-ExtUtils-MakeMaker

    - name: Does git source file exists ?
      command: ls /tmp/git-2.4.0.tar.gz
      ignore_errors: True
      register: git_source_exists

    - name: Download git source file
      get_url: url=https://www.kernel.org/pub/software/scm/git/git-2.4.0.tar.gz dest=/tmp/git-2.4.0.tar.gz
      when: git_source_exists|failed

    - name: Unarchive git.tar.gz
      command: chdir=/tmp/ tar zxf git-2.4.0.tar.gz
      when: git_source_exists|failed

    - name: Is git installed ?
      command: which git
      ignore_errors: True
      register: git_is_installed

    - name: Configure git source
      command: chdir=/tmp/git-2.4.0 ./configure --prefix=/usr/local
      when: git_is_installed|failed

    - name: Make git
      command: chdir=/tmp/git-2.4.0 make prefix=/usr/local all
      when: git_is_installed

    - name: Install git
      command: chdir=/tmp/git-2.4.0 make prefix=/usr/local install
